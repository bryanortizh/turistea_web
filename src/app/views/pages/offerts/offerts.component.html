<div class="mb-4">
    <h2>Paquetes</h2>
    <p class="text-medium-emphasis">Lista de paquetes turisticos</p>

    <div class="d-flex justify-content-end mb-3">
        <button cButton color="primary" size="sm" class="text-white" (click)="showClientsBlock()">
            Ver paquetes {{ state === 1 ? 'desactivados' : 'activos' }}
        </button>
        <button cButton color="secondary" size="sm" class="ms-2 text-white" (click)="savePackage()">
            Agregar
        </button>
    </div>
    <div class="table-responsive">
        <table cTable class="table align-middle">
            <thead cTableColor="dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Nombres</th>
                    <th scope="col">Departamento</th>
                    <th scope="col">Fecha de creación</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of dataPackage; let i = index">
                    <th scope="row">{{user?.id}}</th>
                    <td>{{user?.title}}</td>
                    <td>{{user?.name_region}}</td>
                    <td>{{user?.created | date: 'short'}}</td>
                    <td>
                        <button cButton color="success" size="sm" class="me-2 text-white" (click)="openPackageModal(i)">
                            Ver datos </button>

                        <button cButton color="warning" size="sm" class="me-2 text-white"
                            (click)="openEditPackageModal(i)">
                            Editar</button>

                        <button cButton color="info" size="sm" class="me-2 text-white"
                            (click)="openRouterPackage(user.id)">Configurar</button>

                        <button cButton [color]="user.state === true ? 'danger' : 'success'" size="sm"
                            class="me-2 text-white" (click)="blockUser(user)">
                            {{ user?.state === true ? 'Desactivar' : 'Activar' }}
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div *ngIf="dataPackage.length === 0" class="alert alert-info" role="alert">
        No se encontraron paquetes.
    </div>

    <nav class="mt-3" *ngIf="pageTotal > 1 && dataPackage.length > 0">
        <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="page === 1">
                <button class="page-link" (click)="changePage(page - 1)" [disabled]="page === 1">Anterior</button>
            </li>
            <li class="page-item" *ngFor="let p of [].constructor(pageTotal); let i = index"
                [class.active]="page === i + 1">
                <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="page === pageTotal">
                <button class="page-link" (click)="changePage(page + 1)"
                    [disabled]="page === pageTotal">Siguiente</button>
            </li>
        </ul>
    </nav>
</div>

<c-modal [visible]="visibleAddPackageModal" (visibleChange)="visibleAddPackageModal = $event" size="lg">
    <c-modal-header>
        <h5 cModalTitle>Registrar paquete turístico</h5>
        <button cButtonClose (click)="closeAddPackageModal()"></button>
    </c-modal-header>
    <form [formGroup]="packageForm">
        <c-modal-body>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="title" class="form-label">Título del paquete *</label>
                    <input type="text" id="title" class="form-control" formControlName="title" />
                    <div *ngIf="packageForm.get('title')?.invalid && packageForm.get('title')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('title')?.errors?.['required']">El título es requerido.</div>
                        <div *ngIf="packageForm.get('title')?.errors?.['minlength']">Mínimo 3 caracteres.</div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="name_region" class="form-label">Departamento *</label>
                    <input type="text" id="name_region" class="form-control" formControlName="name_region" />
                    <div *ngIf="packageForm.get('name_region')?.invalid && packageForm.get('name_region')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('name_region')?.errors?.['required']">La departamento es requerida.
                        </div>
                    </div>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Conductor" formControlName="id_driver" [searchFunction]="searchDrivers"
                        placeholder="Buscar conductor por nombre..." notFoundText="No se encontraron conductores"
                        bindLabel="textSearch" bindValue="id" [required]="true"
                        errorMessage="El conductor es requerido">
                    </app-search-select>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Guía" formControlName="id_guide" [searchFunction]="searchGuides"
                        placeholder="Buscar guía por nombre..." notFoundText="No se encontraron guías"
                        bindLabel="textSearch" bindValue="id" [required]="true" errorMessage="El guía es requerido">
                    </app-search-select>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Terramoza" formControlName="id_terrace" [searchFunction]="searchTerraces"
                        placeholder="Buscar terramoza por nombre..." notFoundText="No se encontraron terramozas"
                        bindLabel="textSearch" bindValue="id" [required]="true"
                        errorMessage="La terramoza es requerida">
                    </app-search-select>
                </div>

                <div class="col-md-12 mb-3">
                    <label for="description" class="form-label">Descripción *</label>
                    <textarea id="description" class="form-control" formControlName="description" rows="4"></textarea>
                    <div *ngIf="packageForm.get('description')?.invalid && packageForm.get('description')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('description')?.errors?.['required']">La descripción es requerida.
                        </div>
                        <div *ngIf="packageForm.get('description')?.errors?.['minlength']">Mínimo 10 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="quantity_person" class="form-label">Cantidad de personas *</label>
                    <input type="number" id="quantity_person" class="form-control" minlength="1"
                        formControlName="quantity_person" />
                    <div *ngIf="packageForm.get('quantity_person')?.invalid && packageForm.get('quantity_person')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('quantity_person')?.errors?.['required']">La cantidad de personas es
                            requerida.</div>
                        <div *ngIf="packageForm.get('quantity_person')?.errors?.['min']">Debe ser al menos 1 persona.
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mb-3">
                    <label for="image_bg" class="form-label">Imagen de fondo del paquete *</label>
                    <input type="file" id="image_bg" class="form-control" (change)="onFileSelect($event, 'image_bg')"
                        accept="image/*" />
                    <div *ngIf="packageForm.get('image_bg')?.invalid && packageForm.get('image_bg')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('image_bg')?.errors?.['required']">La imagen de fondo es requerida.
                        </div>
                    </div>
                </div>

                <div class="col-md-12 mb-3">
                    <label for="image_bg_two" class="form-label">Segunda imagen de fondo del paquete *</label>
                    <input type="file" id="image_bg_two" class="form-control"
                        (change)="onFileSelect($event, 'image_bg_two')" accept="image/*" />
                    <div *ngIf="packageForm.get('image_bg_two')?.invalid && packageForm.get('image_bg_two')?.touched"
                        class="text-danger small">
                        <div *ngIf="packageForm.get('image_bg_two')?.errors?.['required']">La segunda imagen de fondo es
                            requerida.
                        </div>
                    </div>
                </div>
            </div>
        </c-modal-body>
        <c-modal-footer>
            <button type="button" cButton color="secondary" (click)="closeAddPackageModal()">Cancelar</button>
            <button type="submit" cButton color="primary" [disabled]="packageForm.invalid"
                (click)="createPackage()">Registrar paquete</button>
        </c-modal-footer>
    </form>
</c-modal>

<c-modal [visible]="visiblePackageModal" (visibleChange)="visiblePackageModal = $event">
    <c-modal-header>
        <h5 cModalTitle>Datos del paquete</h5>
        <button cButtonClose (click)="closePackageModal()"></button>
    </c-modal-header>
    <c-modal-body *ngIf="selectedPackage">
        <div class="row">
            <div class="col-6 mb-2">
                <strong>ID:</strong> {{ selectedPackage.id }}
            </div>
            <div class="col-6 mb-2">
                <strong>Titulo:</strong> {{ selectedPackage.title }}
            </div>
            <div class="col-6 mb-2">
                <strong>Departamento:</strong> {{ selectedPackage.name_region }}
            </div>
            <div class="col-12 mb-2">
                <strong>Descripción:</strong> {{ selectedPackage.description }}
            </div>
            <div class="col-6 mb-2">
                <strong>Cantidad de personas:</strong> {{ selectedPackage.quantity_person }}
            </div>
            <div class="col-6 mb-2">
                <strong>Estado:</strong> {{ selectedPackage.state ? 'Activo' : 'Bloqueado' }}
            </div>
            <div class="col-6 mb-2">
                <strong>Creado:</strong> {{ selectedPackage.created | date:'short' }}
            </div>
            <div class="col-6 mb-2">
                <strong>Actualizado:</strong> {{ selectedPackage.updated | date:'short' }}
            </div>
            <div class="row">
                <div class="col-6 mb-2">
                    <strong>Imagen Paquete:</strong><br />
                    <img *ngIf="selectedPackage.path_bg" [src]="selectedPackage.path_bg" alt="Imagen del vehículo"
                        class="img-fluid mt-2" style="max-width: 200px; border: 1px solid #ccc; padding: 5px;" />
                </div>
                <div class="col-6 mb-2">
                    <strong>Segunda Imagen Paquete:</strong><br />
                    <img *ngIf="selectedPackage.path_bg_two" [src]="selectedPackage.path_bg_two"
                        alt="Imagen del vehículo" class="img-fluid mt-2"
                        style="max-width: 200px; border: 1px solid #ccc; padding: 5px;" />
                </div>
            </div>
        </div>
    </c-modal-body>
    <c-modal-footer>
        <button cButton color="secondary" (click)="closePackageModal()">Cerrar</button>
    </c-modal-footer>
</c-modal>

<!-- Modal para editar paquete turístico -->
<c-modal [visible]="visibleEditPackageModal" (visibleChange)="visibleEditPackageModal = $event" size="lg">
    <c-modal-header>
        <h5 cModalTitle>Editar paquete turístico</h5>
        <button cButtonClose (click)="closeEditPackageModal()"></button>
    </c-modal-header>
    <form [formGroup]="editPackageForm">
        <c-modal-body>
            <div class="row">
                <input type="hidden" formControlName="id" />

                <div class="col-md-6 mb-3">
                    <label for="edit_title" class="form-label">Título del paquete *</label>
                    <input type="text" id="edit_title" class="form-control" formControlName="title" />
                    <div *ngIf="editPackageForm.get('title')?.invalid && editPackageForm.get('title')?.touched"
                        class="text-danger small">
                        <div *ngIf="editPackageForm.get('title')?.errors?.['required']">El título es requerido.</div>
                        <div *ngIf="editPackageForm.get('title')?.errors?.['minlength']">Mínimo 3 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_name_region" class="form-label">Departamento *</label>
                    <input type="text" id="edit_name_region" class="form-control" formControlName="name_region" />
                    <div *ngIf="editPackageForm.get('name_region')?.invalid && editPackageForm.get('name_region')?.touched"
                        class="text-danger small">
                        <div *ngIf="editPackageForm.get('name_region')?.errors?.['required']">El departamento es
                            requerido.</div>
                    </div>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Conductor" formControlName="id_driver" [searchFunction]="searchDrivers"
                        [getAllFunction]="getAllDrivers" placeholder="Buscar conductor por nombre..."
                        notFoundText="No se encontraron conductores" bindLabel="textSearch" bindValue="id"
                        [required]="true" errorMessage="El conductor es requerido">
                    </app-search-select>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Guía" formControlName="id_guide" [searchFunction]="searchGuides"
                        [getAllFunction]="getAllGuides" placeholder="Buscar guía por nombre..."
                        notFoundText="No se encontraron guías" bindLabel="textSearch" bindValue="id" [required]="true"
                        errorMessage="El guía es requerido">
                    </app-search-select>
                </div>

                <div class="col-md-12">
                    <app-search-select label="Terramoza" formControlName="id_terrace" [searchFunction]="searchTerraces"
                        [getAllFunction]="getAllTerraces" placeholder="Buscar terramoza por nombre..."
                        notFoundText="No se encontraron terramozas" bindLabel="textSearch" bindValue="id"
                        [required]="true" errorMessage="La terramoza es requerida">
                    </app-search-select>
                </div>

                <div class="col-md-12 mb-3">
                    <label for="edit_description" class="form-label">Descripción *</label>
                    <textarea id="edit_description" class="form-control" formControlName="description"
                        rows="4"></textarea>
                    <div *ngIf="editPackageForm.get('description')?.invalid && editPackageForm.get('description')?.touched"
                        class="text-danger small">
                        <div *ngIf="editPackageForm.get('description')?.errors?.['required']">La descripción es
                            requerida.</div>
                        <div *ngIf="editPackageForm.get('description')?.errors?.['minlength']">Mínimo 10 caracteres.
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="edit_quantity_person" class="form-label">Cantidad de personas *</label>
                    <input type="number" id="edit_quantity_person" class="form-control" minlength="1"
                        formControlName="quantity_person" />
                    <div *ngIf="editPackageForm.get('quantity_person')?.invalid && editPackageForm.get('quantity_person')?.touched"
                        class="text-danger small">
                        <div *ngIf="editPackageForm.get('quantity_person')?.errors?.['required']">La cantidad de
                            personas es requerida.</div>
                        <div *ngIf="editPackageForm.get('quantity_person')?.errors?.['min']">Debe ser al menos 1
                            persona.</div>
                    </div>
                </div>


                <div class="col-md-12 mb-3">
                    <label for="edit_image_bg" class="form-label">Nueva imagen de fondo (opcional)</label>
                    <input type="file" id="edit_image_bg" class="form-control"
                        (change)="onFileSelectEdit($event, 'image_bg')" accept="image/*" />
                    <small class="text-muted">Deja vacío si no deseas cambiar la imagen actual</small>
                </div>

                <div class="col-md-12 mb-3">
                    <label for="edit_image_bg_two" class="form-label">Nueva segunda imagen de fondo (opcional)</label>
                    <input type="file" id="edit_image_bg_two" class="form-control"
                        (change)="onFileSelectEdit($event, 'image_bg_two')" accept="image/*" />
                    <small class="text-muted">Deja vacío si no deseas cambiar la segunda imagen actual</small>
                </div>

            </div>
        </c-modal-body>
        <c-modal-footer>
            <button type="button" cButton color="secondary" (click)="closeEditPackageModal()">Cancelar</button>
            <button type="submit" cButton color="primary" [disabled]="editPackageForm.invalid"
                (click)="updatePackage()">Actualizar paquete</button>
        </c-modal-footer>
    </form>
</c-modal>