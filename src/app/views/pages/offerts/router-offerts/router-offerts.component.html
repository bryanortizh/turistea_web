<div class="mb-4">
  <app-loading [show]="loading"  [message]="'Cargando rutas...'"></app-loading>
  <h2>Tracking</h2>
  <p class="text-medium-emphasis">Configuracion del paquete {{ id }}</p>

  <div class="d-flex justify-content-end mb-3">
    <button cButton color="primary" size="sm" class="text-white" (click)="showClientsBlock()">
      Ver configuraciones desactivadas {{ state === 1 ? "desactivados" : "activos" }}
    </button>
    <button cButton color="secondary" size="sm" class="ms-2 text-white" (click)="savePackage()">
      Agregar
    </button>
  </div>
  <div class="table-responsive">
    <table cTable class="table align-middle">
      <thead cTableColor="dark">
        <tr>
          <th scope="col">#</th>
          <th scope="col">Nombres</th>
          <th scope="col">Provincia</th>
          <th scope="col">Distrito</th>
          <th scope="col">Fecha de creaciÃ³n</th>
          <th scope="col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of dataPackage; let i = index">
          <th scope="row">{{ user?.id }}</th>
          <td>{{ user?.title }}</td>
          <td>{{ user?.name_province }}</td>
          <td>{{ user?.name_district }}</td>
          <td>{{ user?.created | date : "short" }}</td>
          <td>
            <button cButton color="success" size="sm" class="me-2 text-white" (click)="openPackageModal(i)">
              Ver datos
            </button>
            <button cButton color="warning" size="sm" class="me-2 text-white" (click)="editPackage(user)">
              Editar
            </button>
            <button cButton [color]="user.state === true ? 'danger' : 'success'" size="sm" class="me-2 text-white"
              (click)="blockUser(user)">
              {{ user?.state === true ? "Desactivar" : "Activar" }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="dataPackage.length === 0" class="alert alert-info" role="alert">
    No se encontraron configuraciones.
  </div>

  <nav class="mt-3" *ngIf="pageTotal > 1 && dataPackage.length > 0">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="page === 1">
        <button class="page-link" (click)="changePage(page - 1)" [disabled]="page === 1">
          Anterior
        </button>
      </li>
      <li class="page-item" *ngFor="let p of [].constructor(pageTotal); let i = index" [class.active]="page === i + 1">
        <button class="page-link" (click)="changePage(i + 1)">
          {{ i + 1 }}
        </button>
      </li>
      <li class="page-item" [class.disabled]="page === pageTotal">
        <button class="page-link" (click)="changePage(page + 1)" [disabled]="page === pageTotal">
          Siguiente
        </button>
      </li>
    </ul>
  </nav>
</div>

<c-modal backdrop="static" [visible]="visibleAddPackageModal" (visibleChange)="visibleAddPackageModal = $event" size="xl">
  <c-modal-header>
    <h5 cModalTitle>{{ isEditMode ? 'Editar' : 'Registrar' }} configuraciÃ³n de paquete turÃ­stico</h5>
    <button cButtonClose (click)="closeAddPackageModal()"></button>
  </c-modal-header>
  <form [formGroup]="packageForm">
    <c-modal-body style="max-height: 70vh; overflow-y: auto;">
      <div class="row">

        <div class="col-12 mb-4">
          <h6 class="text-primary border-bottom pb-2">ğŸ“‹ InformaciÃ³n General</h6>
        </div>

        <div class="col-md-6 mb-3">
          <label for="title" class="form-label">TÃ­tulo del paquete *</label>
          <input type="text" id="title" class="form-control" formControlName="title"
            placeholder="Ej: Cuzco Paquete de viaje" />
          <div *ngIf="
              packageForm.get('title')?.invalid &&
              packageForm.get('title')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('title')?.errors?.['required']">
              El tÃ­tulo es requerido.
            </div>
            <div *ngIf="packageForm.get('title')?.errors?.['minlength']">
              MÃ­nimo 3 caracteres.
            </div>
          </div>
        </div>

        <input type="hidden" formControlName="id_package" />

        <div class="col-md-6 mb-3">
          <label for="description" class="form-label">DescripciÃ³n *</label>
          <textarea id="description" class="form-control" formControlName="description" rows="3"
            placeholder="DescripciÃ³n detallada del paquete..."></textarea>
          <div *ngIf="
              packageForm.get('description')?.invalid &&
              packageForm.get('description')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('description')?.errors?.['required']">
              La descripciÃ³n es requerida.
            </div>
            <div *ngIf="packageForm.get('description')?.errors?.['minlength']">
              MÃ­nimo 10 caracteres.
            </div>
          </div>
        </div>

        <div class="col-12 mb-4">
          <h6 class="text-primary border-bottom pb-2">ğŸŒ UbicaciÃ³n</h6>
        </div>

        <div class="col-md-4 mb-3">
          <label for="name_district" class="form-label">Distrito *</label>
          <input type="text" id="name_district" class="form-control" formControlName="name_district"
            placeholder="Ej: CaÃ±ete" />
          <div *ngIf="
              packageForm.get('name_district')?.invalid &&
              packageForm.get('name_district')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('name_district')?.errors?.['required']">
              El distrito es requerido.
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label for="name_province" class="form-label">Provincia *</label>
          <input type="text" id="name_province" class="form-control" formControlName="name_province"
            placeholder="Ej: CaÃ±ete" />
          <div *ngIf="
              packageForm.get('name_province')?.invalid &&
              packageForm.get('name_province')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('name_province')?.errors?.['required']">
              La provincia es requerida.
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label for="address_initial" class="form-label">DirecciÃ³n Inicial *</label>
          <input type="text" id="address_initial" class="form-control" formControlName="address_initial"
            placeholder="Ej: Av. Principal 123, Ciudad" />
          <div *ngIf="
              packageForm.get('address_initial')?.invalid &&
              packageForm.get('address_initial')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('address_initial')?.errors?.['required']">
              La direcciÃ³n inicial es requerida.
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label for="address_final" class="form-label">DirecciÃ³n Final *</label>
          <input type="text" id="address_final" class="form-control" formControlName="address_final"
            placeholder="Ej: Av. Secundaria 456, Ciudad" />
          <div *ngIf="
              packageForm.get('address_final')?.invalid &&
              packageForm.get('address_final')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('address_final')?.errors?.['required']">
              La direcciÃ³n final es requerida.
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <label for="price_route" class="form-label">Precio de la ruta *</label>
          <input type="number" id="price_route" class="form-control" formControlName="price_route"
            placeholder="Ej: 150.00" />
          <div *ngIf="
              packageForm.get('price_route')?.invalid &&
              packageForm.get('price_route')?.touched
            " class="text-danger small">
            <div *ngIf="packageForm.get('price_route')?.errors?.['required']">
              El precio de la ruta es requerido.
            </div>
          </div>
        </div>

        <div class="col-12 mb-4">
          <h6 class="text-primary border-bottom pb-2">ğŸ–¼ï¸ ImÃ¡genes del Paquete</h6>
        </div>

        <div class="col-md-4 mb-3">
          <label for="image_one" class="form-label">Imagen Principal</label>
          <input type="file" id="image_one" class="form-control" (change)="onFileSelect($event, 'image_one')"
            accept="image/*" />
          <small class="text-muted">Imagen principal del paquete</small>
        </div>

        <div class="col-md-4 mb-3">
          <label for="image_two" class="form-label">Imagen Secundaria</label>
          <input type="file" id="image_two" class="form-control" (change)="onFileSelect($event, 'image_two')"
            accept="image/*" />
          <small class="text-muted">Imagen secundaria del paquete</small>
        </div>

        <div class="col-md-4 mb-3">
          <label for="image_tree" class="form-label">Imagen Adicional</label>
          <input type="file" id="image_tree" class="form-control" (change)="onFileSelect($event, 'image_tree')"
            accept="image/*" />
          <small class="text-muted">Imagen adicional del paquete</small>
        </div>

        <div class="col-12 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-primary border-bottom pb-2 mb-0">ğŸ—ºï¸ Rutas del Itinerario</h6>
            <button type="button" cButton color="success" size="sm" (click)="addRoute()" class="text-white">
              â• Agregar Ruta
            </button>
          </div>
        </div>

        <div formArrayName="route_json">
          <div *ngFor="let routeControl of routeFormArray.controls; let i = index" [formGroupName]="i"
            class="col-12 mb-4">
            <div class="card border-2 border-info">
              <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-info">
                  ğŸš© Ruta {{ i + 1 }}
                </h6>
                <button type="button" cButton color="danger" size="sm" (click)="removeRoute(i)"
                  [disabled]="routeFormArray.length <= 1" class="text-white">
                  ğŸ—‘ï¸ Eliminar
                </button>
              </div>
              <div class="card-body">
                <div class="row">

                  <input type="hidden" formControlName="id" />

                  <input type="hidden" formControlName="index" />

                  <div class="col-md-6 mb-3">
                    <label [for]="'route_title_' + i" class="form-label">TÃ­tulo de la ruta *</label>
                    <input type="text" [id]="'route_title_' + i" class="form-control" formControlName="title"
                      placeholder="Ej: Punto de Inicio" />
                    <div *ngIf="
                        routeControl.get('title')?.invalid &&
                        routeControl.get('title')?.touched
                      " class="text-danger small">
                      <div *ngIf="routeControl.get('title')?.errors?.['required']">
                        El tÃ­tulo es requerido.
                      </div>
                      <div *ngIf="routeControl.get('title')?.errors?.['minlength']">
                        MÃ­nimo 3 caracteres.
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label [for]="'route_image_' + i" class="form-label">Imagen de la ruta</label>
                    <input type="file" [id]="'route_image_' + i" class="form-control"
                      (change)="onRouteImageSelect($event, i)" accept="image/*" />
                    <small class="text-muted">Imagen representativa de esta parada</small>
                  </div>

                  <div class="col-md-12 mb-3">
                    <label [for]="'route_description_' + i" class="form-label">DescripciÃ³n de la ruta *</label>
                    <textarea [id]="'route_description_' + i" class="form-control" formControlName="description"
                      rows="3" placeholder="Ej: Lugar de encuentro y inicio del recorrido turÃ­stico"></textarea>
                    <div *ngIf="
                        routeControl.get('description')?.invalid &&
                        routeControl.get('description')?.touched
                      " class="text-danger small">
                      <div *ngIf="routeControl.get('description')?.errors?.['required']">
                        La descripciÃ³n es requerida.
                      </div>
                      <div *ngIf="routeControl.get('description')?.errors?.['minlength']">
                        MÃ­nimo 10 caracteres.
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </c-modal-body>
    <c-modal-footer class="bg-light">
      <button type="button" cButton color="secondary" (click)="closeAddPackageModal()">
        âŒ Cancelar
      </button>
      <button type="submit" cButton color="primary" [disabled]="packageForm.invalid || loading"
        (click)="isEditMode ? updatePackage() : createPackage()" class="text-white">
        {{ isEditMode ? 'ğŸ“ Actualizar ConfiguraciÃ³n' : 'âœ… Registrar ConfiguraciÃ³n' }}
      </button>
    </c-modal-footer>
  </form>
</c-modal>

<c-modal backdrop="static" [visible]="visiblePackageModal" (visibleChange)="visiblePackageModal = $event" size="xl">
  <c-modal-header>
    <h5 cModalTitle>ğŸ“‹ Detalle completo de la configuraciÃ³n</h5>
    <button cButtonClose (click)="closePackageModal()"></button>
  </c-modal-header>
  <c-modal-body *ngIf="selectedPackage" style="max-height: 70vh; overflow-y: auto;">
    <div class="row">

      <div class="col-12 mb-4">
        <h6 class="text-primary border-bottom pb-2">ğŸ“‹ InformaciÃ³n General</h6>
      </div>

      <div class="col-md-3 mb-3">
        <strong>ğŸ†” ID:</strong>
        <div class="text-muted">{{ selectedPackage.id }}</div>
      </div>

      <div class="col-md-9 mb-3">
        <strong>ğŸ“ TÃ­tulo:</strong>
        <div class="text-muted">{{ selectedPackage.title }}</div>
      </div>

      <div class="col-md-12 mb-3">
        <strong>ğŸ“„ DescripciÃ³n:</strong>
        <div class="text-muted">{{ selectedPackage.description }}</div>
      </div>

      <div class="col-12 mb-4">
        <h6 class="text-primary border-bottom pb-2">ğŸŒ UbicaciÃ³n</h6>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ˜ï¸ Distrito:</strong>
        <div class="text-muted">
          {{ selectedPackage.name_district || 'No especificado' }}
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ™ï¸ Provincia:</strong>
        <div class="text-muted">
          {{ selectedPackage.name_province || 'No especificado' }}
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ  DirecciÃ³n Inicial:</strong>
        <div class="text-muted">
          {{ selectedPackage.address_initial || 'No especificado' }}
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ  DirecciÃ³n Final:</strong>
        <div class="text-muted">
          {{ selectedPackage.address_final || 'No especificado' }}
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ’² Precio de la Ruta:</strong>
        <div class="text-muted">
          {{ selectedPackage.price_route ? ('S/. ' + selectedPackage.price_route) : 'No especificado' }}
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ“¦ ID Paquete:</strong>
        <div class="text-muted">{{ selectedPackage.id_package }}</div>
      </div>

      <div class="col-12 mb-4">
        <h6 class="text-primary border-bottom pb-2">â„¹ï¸ Estado y Fechas</h6>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ”˜ Estado:</strong>
        <div>
          <span [class]="selectedPackage.state ? 'badge bg-success' : 'badge bg-danger'">
            {{ selectedPackage.state ? "âœ… Activo" : "âŒ Bloqueado" }}
          </span>
        </div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ“… Creado:</strong>
        <div class="text-muted">{{ selectedPackage.created | date : "medium" }}</div>
      </div>

      <div class="col-md-4 mb-3">
        <strong>ğŸ”„ Actualizado:</strong>
        <div class="text-muted">{{ selectedPackage.updated | date : "medium" }}</div>
      </div>

      <div class="col-12 mb-4">
        <h6 class="text-primary border-bottom pb-2">ğŸ–¼ï¸ ImÃ¡genes del Paquete</h6>
      </div>

      <div class="col-md-4 mb-3" *ngIf="selectedPackage.path_bgone">
        <strong>ğŸ–¼ï¸ Imagen Principal:</strong>
        <div class="text-muted small mb-1">{{ selectedPackage.size_bgone }}</div>
        <div class="mt-2">
          <img [src]="selectedPackage.path_bgone" alt="Imagen principal" class="img-fluid rounded"
            style="max-width: 150px; border: 2px solid #007bff;" />
        </div>
      </div>

      <div class="col-md-4 mb-3" *ngIf="selectedPackage.path_bgtwo">
        <strong>ğŸ–¼ï¸ Imagen Secundaria:</strong>
        <div class="text-muted small mb-1">{{ selectedPackage.size_bgtwo }}</div>
        <div class="mt-2">
          <img [src]="selectedPackage.path_bgtwo" alt="Imagen secundaria" class="img-fluid rounded"
            style="max-width: 150px; border: 2px solid #28a745;" />
        </div>
      </div>

      <div class="col-md-4 mb-3" *ngIf="selectedPackage.path_bgthree">
        <strong>ğŸ–¼ï¸ Imagen Adicional:</strong>
        <div class="text-muted small mb-1">{{ selectedPackage.size_bgthree }}</div>
        <div class="mt-2">
          <img [src]="selectedPackage.path_bgthree" alt="Imagen adicional" class="img-fluid rounded"
            style="max-width: 150px; border: 2px solid #ffc107;" />
        </div>
      </div>

      <div class="col-12 mb-3"
        *ngIf="!selectedPackage.path_bgone && !selectedPackage.path_bgtwo && !selectedPackage.path_bgthree">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          No se encontraron imÃ¡genes para este paquete.
        </div>
      </div>

      <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-primary border-bottom pb-2 mb-0">ğŸ—ºï¸ Rutas del Itinerario</h6>
          <span class="badge bg-info">{{ selectedPackageRoutes.length }} ruta(s)</span>
        </div>
      </div>

      <div class="col-12" *ngIf="selectedPackageRoutes.length === 0">
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          No se encontraron rutas configuradas para este paquete.
        </div>
      </div>

      <div class="col-12" *ngFor="let route of selectedPackageRoutes; let i = index">
        <div class="card mb-3 border-2" [class]="'border-' + (i % 2 === 0 ? 'info' : 'success')">
          <div class="card-header" [class]="'bg-' + (i % 2 === 0 ? 'info' : 'success') + ' text-white'">
            <h6 class="mb-0">
              ğŸš© Ruta {{ route.id || (i + 1) }}
              <small class="ms-2">(Ãndice: {{ route.index !== undefined ? route.index : i }})</small>
            </h6>
          </div>
          <div class="card-body">
            <div class="row">

              <div class="col-md-8">
                <div class="mb-2">
                  <strong>ğŸ“ TÃ­tulo:</strong>
                  <div class="text-muted">{{ route.title }}</div>
                </div>

                <div class="mb-2">
                  <strong>ğŸ“ DescripciÃ³n:</strong>
                  <div class="text-muted">{{ route.description }}</div>
                </div>

              </div>

              <div class="col-md-4" *ngIf="route.bg_image">
                <strong>ğŸ–¼ï¸ Imagen de la ruta:</strong>
                <div class="mt-2">
                  <img [src]="route.bg_image" alt="Imagen de la ruta {{ route.title }}" class="img-fluid rounded"
                    style="max-width: 150px; border: 2px solid #17a2b8;" />
                </div>
              </div>

              <div class="col-md-4" *ngIf="!route.bg_image">
                <div class="d-flex align-items-center justify-content-center h-100">
                  <span class="text-muted">
                    <i class="fas fa-image fa-2x"></i><br>
                    Sin imagen
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </c-modal-body>
  <c-modal-footer class="bg-light">
    <button cButton color="secondary" (click)="closePackageModal()">
      âŒ Cerrar
    </button>
  </c-modal-footer>
</c-modal>