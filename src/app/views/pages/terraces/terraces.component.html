<div class="mb-4">
    <app-loading [show]="loading"  [message]="'Cargando Terramozas...'"></app-loading>
    <h2>Terramozas</h2>
    <p class="text-medium-emphasis">Lista de terramozas del sistema</p>

    <div class="d-flex justify-content-end mb-3">
        <button cButton color="primary" size="sm" class="text-white" (click)="showClientsBlock()">
            Ver terramozas {{ state === 1 ? 'desactivadas' : 'activas' }}
        </button>
        <button cButton color="secondary" size="sm" class="ms-2 text-white" (click)="saveTerrace()">
            Agregar
        </button>
    </div>
    <div class="table-responsive">
        <table cTable class="table align-middle">
            <thead cTableColor="dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Nombres</th>
                    <th scope="col">Correo</th>
                    <th scope="col">Teléfono</th>
                    <th scope="col">Fecha de creación</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of dataTerrace; let i = index">
                    <th scope="row">{{user?.id}}</th>
                    <td>{{user?.name}}</td>
                    <td>{{user?.email}}</td>
                    <td>{{user?.cellphone}}</td>
                    <td>{{user?.created | date: 'short'}}</td>
                    <td>
                        <button cButton color="success" size="sm" class="me-2 text-white" (click)="openTerraceModal(i)">
                            Ver datos </button>
                        <button cButton color="info" size="sm" class="me-2 text-white" (click)="openEditTerraceModal(i)">
                            Editar
                        </button>
                        <button cButton [color]="user.state === true ? 'danger' : 'success'" size="sm"
                            class="me-2 text-white" (click)="blockUser(user)">
                            {{ user?.state === true ? 'Desactivar' : 'Activar' }}
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div *ngIf="dataTerrace.length === 0" class="alert alert-info" role="alert">
        No se encontraron terramozas.
    </div>

    <nav class="mt-3" *ngIf="pageTotal > 1 && dataTerrace.length > 0">
        <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="page === 1">
                <button class="page-link" (click)="changePage(page - 1)" [disabled]="page === 1">Anterior</button>
            </li>
            <li class="page-item" *ngFor="let p of [].constructor(pageTotal); let i = index"
                [class.active]="page === i + 1">
                <button class="page-link" (click)="changePage(i + 1)">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="page === pageTotal">
                <button class="page-link" (click)="changePage(page + 1)"
                    [disabled]="page === pageTotal">Siguiente</button>
            </li>
        </ul>
    </nav>
</div>

<c-modal [visible]="visibleAddTerraceModal" (visibleChange)="visibleAddTerraceModal = $event" size="lg">
    <c-modal-header>
        <h5 cModalTitle>Registrar terramozas</h5>
        <button cButtonClose (click)="closeAddTerraceModal()"></button>
    </c-modal-header>
    <form [formGroup]="terraceForm">
        <c-modal-body>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Nombre *</label>
                    <input type="text" id="name" class="form-control" formControlName="name" />
                    <div *ngIf="terraceForm.get('name')?.invalid && terraceForm.get('name')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('name')?.errors?.['required']">El nombre es requerido.</div>
                        <div *ngIf="terraceForm.get('name')?.errors?.['minlength']">Mínimo 2 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="lastname" class="form-label">Apellidos *</label>
                    <input type="text" id="lastname" class="form-control" formControlName="lastname" />
                    <div *ngIf="terraceForm.get('lastname')?.invalid && terraceForm.get('lastname')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('lastname')?.errors?.['required']">El apellido es requerido.</div>
                        <div *ngIf="terraceForm.get('lastname')?.errors?.['minlength']">Mínimo 2 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Correo electrónico *</label>
                    <input type="email" id="email" class="form-control" formControlName="email" />
                    <div *ngIf="terraceForm.get('email')?.invalid && terraceForm.get('email')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('email')?.errors?.['required']">El correo es requerido.</div>
                        <div *ngIf="terraceForm.get('email')?.errors?.['email']">Correo inválido.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="cellphone" class="form-label">Celular *</label>
                    <input type="text" id="cellphone" class="form-control" formControlName="cellphone" maxlength="9" />
                    <div *ngIf="terraceForm.get('cellphone')?.invalid && terraceForm.get('cellphone')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('cellphone')?.errors?.['required']">El celular es requerido.</div>
                        <div *ngIf="terraceForm.get('cellphone')?.errors?.['pattern']">Solo números.</div>
                        <div
                            *ngIf="terraceForm.get('cellphone')?.errors?.['minlength'] || terraceForm.get('cellphone')?.errors?.['maxlength']">
                            Debe tener 9 dígitos.
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="type_document" class="form-label">Tipo de documento *</label>
                    <select id="type_document" class="form-select" formControlName="type_document">
                        <option value="">Seleccione tipo</option>
                        <option value="DNI">DNI</option>
                        <option value="CE">Carnet de Extranjería</option>
                        <option value="Pasaporte">Pasaporte</option>
                    </select>
                    <div *ngIf="terraceForm.get('type_document')?.invalid && terraceForm.get('type_document')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('type_document')?.errors?.['required']">El tipo de documento es
                            requerido.</div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="number_document" class="form-label">Número de documento *</label>
                    <input type="text" id="number_document" class="form-control" formControlName="number_document" />
                    <div *ngIf="terraceForm.get('number_document')?.invalid && terraceForm.get('number_document')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('number_document')?.errors?.['required']">El número de documento es
                            requerido.</div>
                        <div *ngIf="terraceForm.get('number_document')?.errors?.['minlength']">Mínimo 8 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="sexo" class="form-label">Género *</label>
                    <select id="sexo" class="form-select" formControlName="sexo">
                        <option value="">Seleccione género</option>
                        <option value="hombre">Masculino</option>
                        <option value="mujer">Femenino</option>
                        <option value="no especificado">Otro</option>
                    </select>
                    <div *ngIf="terraceForm.get('sexo')?.invalid && terraceForm.get('sexo')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('sexo')?.errors?.['required']">El género es requerido.</div>
                    </div>
                </div>


                <div class="col-md-6 mb-3">
                    <label for="image_photo" class="form-label">Imagen del documento</label>
                    <input type="file" id="image_photo" class="form-control"
                        (change)="onFileSelect($event, 'image_photo')" accept="image/*" />
                    <div *ngIf="terraceForm.get('image_photo')?.invalid && terraceForm.get('image_photo')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('image_photo')?.errors?.['required']">La imagen del documento es
                            requerida.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="image_document" class="form-label">Imagen documento</label>
                    <input type="file" id="image_document" class="form-control"
                        (change)="onFileSelect($event, 'image_document')" accept="image/*" />
                    <div *ngIf="terraceForm.get('image_document')?.invalid && terraceForm.get('image_document')?.touched"
                        class="text-danger small">
                        <div *ngIf="terraceForm.get('image_document')?.errors?.['required']">La imagen del documento es
                            requerida.</div>
                    </div>
                </div>
            </div>

        </c-modal-body>
        <c-modal-footer>
            <button type="button" cButton color="secondary" (click)="closeAddTerraceModal()">Cancelar</button>
            <button type="submit" cButton color="primary" [disabled]="terraceForm.invalid || loading"
                (click)="createTerrace()">Registrar terramozas</button>
        </c-modal-footer>
    </form>
</c-modal>

<c-modal [visible]="visibleEditTerraceModal" (visibleChange)="visibleEditTerraceModal = $event" size="lg">
    <c-modal-header>
        <h5 cModalTitle>Editar terramozas</h5>
        <button cButtonClose (click)="closeEditTerraceModal()"></button>
    </c-modal-header>
    <form [formGroup]="editTerraceForm">
        <c-modal-body>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="edit_name" class="form-label">Nombre *</label>
                    <input type="text" id="edit_name" class="form-control" formControlName="name" />
                    <div *ngIf="editTerraceForm.get('name')?.invalid && editTerraceForm.get('name')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('name')?.errors?.['required']">El nombre es requerido.</div>
                        <div *ngIf="editTerraceForm.get('name')?.errors?.['minlength']">Mínimo 2 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_lastname" class="form-label">Apellidos *</label>
                    <input type="text" id="edit_lastname" class="form-control" formControlName="lastname" />
                    <div *ngIf="editTerraceForm.get('lastname')?.invalid && editTerraceForm.get('lastname')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('lastname')?.errors?.['required']">El apellido es requerido.
                        </div>
                        <div *ngIf="editTerraceForm.get('lastname')?.errors?.['minlength']">Mínimo 2 caracteres.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_email" class="form-label">Correo electrónico *</label>
                    <input type="email" id="edit_email" class="form-control" formControlName="email" />
                    <div *ngIf="editTerraceForm.get('email')?.invalid && editTerraceForm.get('email')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('email')?.errors?.['required']">El correo es requerido.</div>
                        <div *ngIf="editTerraceForm.get('email')?.errors?.['email']">Correo inválido.</div>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_cellphone" class="form-label">Celular *</label>
                    <input type="text" id="edit_cellphone" class="form-control" formControlName="cellphone"
                        maxlength="9" />
                    <div *ngIf="editTerraceForm.get('cellphone')?.invalid && editTerraceForm.get('cellphone')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('cellphone')?.errors?.['required']">El celular es requerido.
                        </div>
                        <div *ngIf="editTerraceForm.get('cellphone')?.errors?.['pattern']">Solo números.</div>
                        <div
                            *ngIf="editTerraceForm.get('cellphone')?.errors?.['minlength'] || editTerraceForm.get('cellphone')?.errors?.['maxlength']">
                            Debe tener 9 dígitos.
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="edit_type_document" class="form-label">Tipo de documento *</label>
                    <select id="edit_type_document" class="form-select" formControlName="type_document">
                        <option value="">Seleccione tipo</option>
                        <option value="DNI">DNI</option>
                        <option value="CE">Carnet de Extranjería</option>
                        <option value="Pasaporte">Pasaporte</option>
                    </select>
                    <div *ngIf="editTerraceForm.get('type_document')?.invalid && editTerraceForm.get('type_document')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('type_document')?.errors?.['required']">El tipo de documento es
                            requerido.</div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="edit_number_document" class="form-label">Número de documento *</label>
                    <input type="text" id="edit_number_document" class="form-control"
                        formControlName="number_document" />
                    <div *ngIf="editTerraceForm.get('number_document')?.invalid && editTerraceForm.get('number_document')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('number_document')?.errors?.['required']">El número de documento
                            es requerido.</div>
                        <div *ngIf="editTerraceForm.get('number_document')?.errors?.['minlength']">Mínimo 8 caracteres.
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="edit_sexo" class="form-label">Género *</label>
                    <select id="edit_sexo" class="form-select" formControlName="sexo">
                        <option value="">Seleccione género</option>
                        <option value="hombre">Masculino</option>
                        <option value="mujer">Femenino</option>
                        <option value="no especificado">Otro</option>
                    </select>
                    <div *ngIf="editTerraceForm.get('sexo')?.invalid && editTerraceForm.get('sexo')?.touched"
                        class="text-danger small">
                        <div *ngIf="editTerraceForm.get('sexo')?.errors?.['required']">El género es requerido.</div>
                    </div>
                </div>


                <div class="col-md-6 mb-3">
                    <label for="edit_image_photo" class="form-label">Nueva imagen de perfil (opcional)</label>
                    <input type="file" id="edit_image_photo" class="form-control"
                        (change)="onFileSelectEdit($event, 'image_photo')" accept="image/*" />
                    <small class="text-muted">Deja vacío si no quieres cambiar la imagen</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_image_document" class="form-label">Nueva imagen del documento (opcional)</label>
                    <input type="file" id="edit_image_document" class="form-control"
                        (change)="onFileSelectEdit($event, 'image_document')" accept="image/*" />
                    <small class="text-muted">Deja vacío si no quieres cambiar la imagen</small>
                </div>
            </div>
        </c-modal-body>
        <c-modal-footer>
            <button type="button" cButton color="secondary" (click)="closeEditTerraceModal()">Cancelar</button>
            <button type="submit" cButton color="primary" [disabled]="editTerraceForm.invalid || loading"
                (click)="updateTerrace()">Actualizar terramozas</button>
        </c-modal-footer>
    </form>
</c-modal>

<c-modal [visible]="visibleTerraceModal" (visibleChange)="visibleTerraceModal = $event">
    <c-modal-header>
        <h5 cModalTitle>Datos de la terramozas</h5>
        <button cButtonClose (click)="closeTerraceModal()"></button>
    </c-modal-header>
    <c-modal-body *ngIf="selectedTerrace">
        <div class="row">
            <div class="col-6 mb-2">
                <strong>ID:</strong> {{ selectedTerrace.id }}
            </div>
            <div class="col-6 mb-2">
                <strong>Nombre:</strong> {{ selectedTerrace.name }}
            </div>
            <div class="col-6 mb-2">
                <strong>Apellido:</strong> {{ selectedTerrace.lastname }}
            </div>
            <div class="col-6 mb-2">
                <strong>Correo:</strong> {{ selectedTerrace.email }}
            </div>
            <div class="col-6 mb-2">
                <strong>Celular:</strong> {{ selectedTerrace.cellphone }}
            </div>
            <div class="col-6 mb-2">
                <strong>Tipo documento:</strong> {{ selectedTerrace.type_document }}
            </div>
            <div class="col-6 mb-2">
                <strong>N° documento:</strong> {{ selectedTerrace.number_document }}
            </div>
            <div class="col-6 mb-2">
                <strong>Género:</strong> {{ selectedTerrace.sexo }}
            </div>
            <div class="col-6 mb-2">
                <strong>Estado:</strong> {{ selectedTerrace.state ? 'Activo' : 'Bloqueado' }}
            </div>
            <div class="col-6 mb-2">
                <strong>Creado:</strong> {{ selectedTerrace.created | date:'short' }}
            </div>
            <div class="col-6 mb-2">
                <strong>Actualizado:</strong> {{ selectedTerrace.updated | date:'short' }}
            </div>
            <div class="row">
                <div class="col-6 mb-2">
                    <strong>Imagen terramozas:</strong><br />
                    <img *ngIf="selectedTerrace.path_photo" [src]="selectedTerrace.path_photo" alt="Imagen de la terramozas"
                        class="img-fluid mt-2" style="max-width: 200px; border: 1px solid #ccc; padding: 5px;" />
                </div>
                <div class="col-6 mb-2">
                    <strong>Imagen documento:</strong><br />
                    <img *ngIf="selectedTerrace.path_document" [src]="selectedTerrace.path_document"
                        alt="Imagen del documento" class="img-fluid mt-2"
                        style="max-width: 200px; border: 1px solid #ccc; padding: 5px;" />
                </div>
            </div>
        </div>
    </c-modal-body>
    <c-modal-footer>
        <button cButton color="secondary" (click)="closeTerraceModal()">Cerrar</button>
    </c-modal-footer>
</c-modal>